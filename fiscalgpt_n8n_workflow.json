{
  "name": "FiscalGPT - Streamlit Chatbot",
  "nodes": [
    {
      "id": "chat_webhook",
      "name": "Webhook Chat",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [-200, 0],
      "parameters": {
        "httpMethod": "POST",
        "path": "fiscalgpt-chat",
        "responseMode": "onReceived",
        "options": { "responseContentType": "application/json" }
      }
    },
    {
      "id": "router",
      "name": "Detect Message Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [50, 0],
      "parameters": {
        "value": "={{ $json.message.type }}",
        "rules": [
          { "operation": "equal", "value": "text" },
          { "operation": "equal", "value": "image" },
          { "operation": "equal", "value": "sticker" }
        ]
      }
    },
    {
      "id": "role_loader",
      "name": "Load Role (assistant_roles)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [350, -250],
      "credentials": { "supabaseApi": "" },
      "parameters": {
        "operation": "select",
        "table": "assistant_roles",
        "query": "session_id=eq.{{$json.session_id}}",
        "limit": 1
      }
    },
    {
      "id": "memory_loader",
      "name": "Load Chat Memory",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [350, -80],
      "credentials": { "supabaseApi": "" },
      "parameters": {
        "operation": "select",
        "table": "chat_memory_streamlit",
        "query": "session_id=eq.{{$json.session_id}}",
        "limit": 20
      }
    },
    {
      "id": "retriever",
      "name": "Retrieve Knowledge (RAG)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [350, 90],
      "credentials": { "supabaseApi": "" },
      "parameters": {
        "operation": "rpc",
        "rpc": "match_documents",
        "payload": "{\"query\":\"{{$json.message.text}}\", \"match_count\":5}"
      }
    },
    {
      "id": "llm",
      "name": "OpenAI Chat (o4-mini)",
      "type": "n8n-nodes-base.openAIApi",
      "typeVersion": 2,
      "position": [650, -20],
      "credentials": { "openAIApi": "" },
      "parameters": {
        "resource": "chat",
        "operation": "createChatCompletion",
        "model": "gpt-4o-mini",
        "messages": "={{[\n  {\"role\":\"system\", \"content\": $json.role || \"You are FiscalGPT, an expert in taxation.\"},\n  {\"role\":\"user\", \"content\": $json.message_text},\n  {\"role\":\"system\", \"content\": \"Relevant knowledge base:\n\" + JSON.stringify($json.kb)},\n  {\"role\":\"system\", \"content\": \"Conversation memory:\n\" + JSON.stringify($json.memory)}\n]}}",
        "responseFormat": "json"
      }
    },
    {
      "id": "memory_saver",
      "name": "Save chat memory",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [900, -20],
      "credentials": { "supabaseApi": "" },
      "parameters": {
        "operation": "insert",
        "table": "chat_memory_streamlit",
        "data": "{\"session_id\":\"{{$json.session_id}}\", \"role\":\"assistant\", \"message\":\"{{$json.response}}\"}"
      }
    },
    {
      "id": "return_to_streamlit",
      "name": "Return to Streamlit",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1150, -20],
      "parameters": {
        "responseBody": "={{ { response: $json.response } }}"
      }
    },

    /* --- UPLOAD WEBHOOK FLOW --- */

    {
      "id": "upload_webhook",
      "name": "Upload Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [-200, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "fiscalgpt-upload",
        "responseMode": "onReceived",
        "options": { "responseContentType": "application/json" }
      }
    },
    {
      "id": "file_text_extract",
      "name": "Extract Text",
      "type": "n8n-nodes-base.documentExtractText",
      "typeVersion": 1,
      "position": [80, 300],
      "parameters": {
        "fileProperty": "file"
      }
    },
    {
      "id": "embedder",
      "name": "OpenAI Embeddings",
      "type": "n8n-nodes-base.openAIApi",
      "typeVersion": 2,
      "position": [350, 300],
      "credentials": {
        "openAIApi": ""
      },
      "parameters": {
        "resource": "embeddings",
        "modelId": "text-embedding-3-small",
        "input": "={{ $json.text }}"
      }
    },
    {
      "id": "supabase_upsert_kb",
      "name": "Store in KB (assistant_kb)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": { "supabaseApi": "" },
      "parameters": {
        "operation": "insert",
        "table": "assistant_kb",
        "data": "={{ { \"content\": $json.text, \"embedding\": $json.data[0].embedding } }}"
      }
    },
    {
      "id": "return_upload",
      "name": "Return Upload",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [900, 300],
      "parameters": {
        "responseBody": "{\"status\":\"uploaded_and_indexed\"}"
      }
    }
  ],
  "connections": {
    "chat_webhook": {
      "main": [[{ "node": "Detect Message Type", "type": "main", "index": 0 }]]
    },
    "router": {
      "main": [
        [{ "node": "Load Role (assistant_roles)", "type": "main", "index": 0 }],
        [{ "node": "Retrieve Knowledge (RAG)", "type": "main", "index": 0 }],
        [{ "node": "Retrieve Knowledge (RAG)", "type": "main", "index": 0 }],
        [{ "node": "Retrieve Knowledge (RAG)", "type": "main", "index": 0 }]
      ]
    },
    "role_loader": {
      "main": [[{ "node": "Load Chat Memory", "type": "main", "index": 0 }]]
    },
    "memory_loader": {
      "main": [
        [{ "node": "OpenAI Chat (o4-mini)", "type": "main", "index": 0 }]
      ]
    },
    "retriever": {
      "main": [
        [{ "node": "OpenAI Chat (o4-mini)", "type": "main", "index": 0 }]
      ]
    },
    "llm": {
      "main": [[{ "node": "Save chat memory", "type": "main", "index": 0 }]]
    },
    "memory_saver": {
      "main": [[{ "node": "Return to Streamlit", "type": "main", "index": 0 }]]
    },

    "upload_webhook": {
      "main": [[{ "node": "Extract Text", "type": "main", "index": 0 }]]
    },
    "file_text_extract": {
      "main": [[{ "node": "OpenAI Embeddings", "type": "main", "index": 0 }]]
    },
    "embedder": {
      "main": [
        [{ "node": "Store in KB (assistant_kb)", "type": "main", "index": 0 }]
      ]
    },
    "supabase_upsert_kb": {
      "main": [[{ "node": "Return Upload", "type": "main", "index": 0 }]]
    }
  }
}
